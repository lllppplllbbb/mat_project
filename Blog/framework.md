## mat.py
###  卷积头 (Encoder类)
- **作用**：把输入的破图和掩码（遮住的部分）变成一堆特征，方便后面处理。把破图和掩码（遮住的部分）变成小块特征，缩小八倍，方便后面处理。
- **怎么干的**：用4个卷积层，一个改维度，三个缩小图像。
- **为什么**：卷积能抓住局部特征，减少计算量。
- **总结**：像把画切成小格子，记下颜色和形状，方便修。

### Transformer主体 (BasicLayer类, SwinTransformerBlock类)
- **作用**：核心部分，用了好几个"Mask-Aware Transformer块"来修图。每个块都用"Multi-head Contextual Attention"(WindowAttention类)看懂图像的整体关系。
- **怎么干的**：
  - 1 用``SwinTransformerBlock``
  - 2 每个块有`“`Multi-head Contextual Attention”（``WindowAttention``类），只看有效区域（没被遮住的）。
  - 3 改进了传统Transformer：去掉层归一化（因为无效区域多，归一化会乱来），把残差连接改成拼接（先学低频信息，再学细节）。
- **为什么**：Transformer能看远距离关系（比如补天空时参考远处云），动态掩码省计算。
- **总结**：像个聪明画师，盯着整张画，专挑没破的地方学，补得更搭。

### 卷积尾 (Decoder类)
- **作用**：把前面处理好的特征变成一张新的图像。把修好的特征放大回原图大小，生成补全图。
- **怎么干的**：用上采样和卷积（类似StyleGAN），加风格调制（从``MappingNet``来的风格编码），让补的图有特定风格。代码在``Decoder``类。
- **为什么**：上采样恢复高清，风格调制让补图多样（比如天空偏蓝或偏灰）。
- **总结**：把小格子拼回大画，加点艺术风格，画得更漂亮。

### Conv-U-Net (FirstStage类)
- **作用**：把前面处理好的特征变成一张新的图像。最后精修补全图，确保细节完美。
- **怎么干的**：用U-Net结构，结合卷积头来的多尺度特征（跳跃连接），修细节。代码在``FirstStage类``。
- **为什么**：U-Net擅长抓局部细节，跳跃连接保留原图信息。
- **总结**：像画师检查画，擦掉不顺眼的地方，补点小细节。

### 掩码感知机制 (MaskAwareTransformer类)
- **作用**：全程跟踪掩码，告诉模型哪儿需要修。
- **怎么干的**：掩码从输入到输出一直更新，有效区域（没遮住）优先算
- **为什么**：确保模型只在需要修复的地方工作，提高效率。
- **总结**：像给画师个清单，告诉他只修破的地方，别瞎改好的。

### U型结构
- **作用**：整个模型像个U，先缩小（编码），中间修（Transformer），再放大（解码）。
- **怎么干的**：卷积头降采样，Transformer处理，卷积尾上采样，中间还有个小U（Transformer里的多尺度）。
- **总结**：像先把画缩成草稿，修好草稿，再放大成高清画。



## 论文
- 网络结构：  整体结构由 卷积头、Transformer Body、卷积尾和风格操作模块组成。 结合了卷积和Transfomer的优点，对图像进行修复。
- 卷积头： 卷积头主要由四个卷积层构成，其中一个卷积层用于改变输入的维度，其他三个卷积层进行下采样操作。以此产生原图八分之一大小分辨率大小的特征图用作输入Transforer块的Tokens。 使用卷积头的两个原因： ①使用卷积层加入局部归纳先验 ②下采样以降低计算成本
- Transformer Body：
  - 1 改进的Transformer块：  
    - a.删除Layer Normalization层归一化：在大面积缺失的情况下，大部分的token是无效的，层归一化会放大这些无效token        

    - b.删除残差连接，改为concat：残差连接鼓励模型学习高频信息，在训练初期，没有低频的基础，很难直接学习高频细节。 
  - 2 多头上下文注意力模块:利用动态掩模版的方式，只对有效的token进行计算。
      动态掩版模板更新规则：只要当前窗口有一个token是有效的，经过注意力后，该窗口的所有token都会更新为有效的。 如果一个窗口中的所有token都是无效的，经过注意力后，他们仍然无效。
  - 3 Style Manipulation Module：
    - a. 风格操作模块： 风格操作模块主要由两个卷积层构成，其中一个卷积层用于改变输入的维度，另一个卷积层用于恢复输入的维度。
    - b. 风格操作模块的作用： 风格操作模块的作用是将输入的特征图进行风格转换，从而使得输出的特征图更加符合输入的风格。
    - c. 风格编码获取： 通过MappingNet网络从随机噪声生成风格编码，这种方式允许模型生成多样化的修复结果。

- 卷积尾：
  - 1 结构特点： 采用类似StyleGAN的生成网络结构，通过一系列上采样和风格调制的卷积操作逐步恢复图像分辨率。
  - 2 风格调制： 使用从MappingNet获得的风格编码对卷积权重进行调制，使生成的图像符合特定风格。
  - 3 跳跃连接： 利用从卷积头获取的多尺度特征，通过跳跃连接与卷积尾的特征融合，保留更多的图像细节。

- U型结构设计：
  - 1 编码-解码路径： MAT模型整体呈U型结构，先通过卷积头降采样编码，再通过卷积尾上采样解码。
  - 2 多尺度特征处理： Transformer主体在中间层处理特征，采用先下采样再上采样的策略，形成第二个小型U结构。
  - 3 优势： 这种嵌套的U型结构能够同时关注局部细节和全局语义，特别适合图像修复任务。

- 掩码感知机制：
  - 1 掩码传播： 在整个网络中跟踪掩码信息，指导模型关注需要修复的区域。
  - 2 动态更新： 掩码随着特征在网络中的传播而动态更新，反映当前有效信息的分布。
  - 3 注意力引导： 掩码信息用于引导注意力机制，使模型能够区分有效区域和无效区域。


## mat.py的流程图
```mermaid
flowchart TD
  A0["输入图像 Image_in Bx3xHxW"] --> A1["输入遮罩 Mask_in Bx1xHxW"]
  A1 --> A2["第一阶段 FirstStage 粗修复"]

  %% 第一阶段编码流程
  A2 --> B0["拼接 mask - 0.5 和 image * mask"]
  B0 --> B1["卷积 Conv2dLayerPartial + 掩码引导"]
  B1 --> B2["多层 DownConv 下采样到 64x64"]

  %% 第一阶段 Transformer 路径
  B2 --> C1["转换为 Token：feature2token"]
  C1 --> C2["BasicLayer Transformer Block ×5"]
  C2 --> C3["前3层 PatchMerging 下采样"]
  C3 --> C4["中间层插入 WS 风格向量"]
  C4 --> C5["后2层 PatchUpsample 上采样 + 跳跃连接"]
  C5 --> C6["Token2Feature 转回空间特征图"]

  %% 风格解码路径
  C6 --> D1["DecStyleBlock ×N（风格调制 + Skip连接）"]
  D1 --> D2["第一阶段输出图像 x1"]

  %% 第二阶段连接
  D2 --> E0["第二阶段 SynthesisNet 精修复"]
  A0 --> E0
  A1 --> E0

  %% 第二阶段输入构建
  E0 --> F0["构建融合输入：(mask * image) + (1 - mask) * x1"]
  F0 --> F1["拼接 mask - 0.5, blend_img, image * mask"]
  F1 --> F2["Encoder 编码器提取特征 E_features"]

  %% Style 提取与注入
  F2 --> G1["提取 fea_16 特征图"]
  G1 --> G2["to_style 提取风格向量 GS"]
  G1 --> G3["square_embed(ws) → 样式补充 AddN"]
  G2 --> H0["拼接风格向量 GS 和 WS"]

  %% 解码阶段
  H0 --> I0["Decoder 解码器 DecBlock 多层"]
  F2 --> I0
  I0 --> I1["输出图像 x2"]

  %% 输出融合
  I1 --> J0["mask * 原图 + (1 - mask) * x2"]
  J0 --> J1["最终输出图像"]

  %% 标注结构块
  subgraph 第一阶段结构 [FirstStage 粗修复结构]
    B1 --> B2
    B2 --> C1 --> C2 --> C3 --> C4 --> C5 --> C6
    C6 --> D1 --> D2
  end

  subgraph 第二阶段结构 [SynthesisNet 精修复结构]
    F1 --> F2 --> G1
    G1 --> G2 --> H0
    H0 --> I0 --> I1
  end
  ```


